<script>
    // DOM Elements (unchanged)
    const menuBtn = document.getElementById('menuBtn');
    const sidebar = document.getElementById('sidebar');
    const chatArea = document.getElementById('chatArea');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const emojiBtn = document.getElementById('emojiBtn');
    const mediaBtn = document.getElementById('mediaBtn');
    const voiceChatBtn = document.getElementById('voiceChatBtn');
    const sidebarName = document.getElementById('sidebarName');
    const sidebarDesignation = document.getElementById('sidebarDesignation');
    const onlineUsersList = document.getElementById('onlineUsersList');
    const userGroupsList = document.getElementById('userGroupsList');
    const logoutButton = document.getElementById('logout-button');
    const sidebarProfilePhoto = document.getElementById('sidebarProfilePhoto');

    // State Management
    let ws;
    let activeChat = { type: null, id: null, name: null };
    const userMap = new Map();
    const groupMap = new Map();

    // Mock Data (unchanged)
    const mockUsers = [
        { id: 1, name: "Alice Smith", status: "online" },
        { id: 2, name: "Bob Johnson", status: "online" },
        { id: 3, name: "Carol Williams", status: "offline" }
    ];
    const mockGroups = [
        { id: 1, name: "Engineering Team", memberCount: 5 },
        { id: 2, name: "Marketing Team", memberCount: 3 }
    ];

    // WebSocket Connection (unchanged)
    function connectWebSocket() {
        const token = localStorage.getItem('token');
        if (!token) {
            console.log("No token found. Using mock data.");
            loadMockData();
            return;
        }

        ws = new WebSocket(`ws://localhost:8081/ws/chat?token=${token}`);

        ws.onopen = () => {
            console.log('Connected to WebSocket server');
            fetchUserDetails();
            fetchOnlineUsers();
            fetchUserGroups();
        };

        ws.onmessage = (event) => {
            try {
                const message = JSON.parse(event.data);
                console.log('Received:', message);
                if (message.error) {
                    console.error('WebSocket error:', message.error);
                    return;
                }
                displayMessage(message);
            } catch (err) {
                console.error('Error parsing WebSocket message:', err);
            }
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            loadMockData();
        };

        ws.onclose = () => {
            console.log('WebSocket closed, reconnecting...');
            setTimeout(connectWebSocket, 3000);
        };
    }

    // Load Mock Data (unchanged)
    function loadMockData() {
        sidebarName.textContent = localStorage.getItem('sidebarName') || 'John Doe';
        sidebarDesignation.textContent = localStorage.getItem('sidebarDesignation') || 'Software Engineer';
        displayOnlineUsers(mockUsers);
        displayUserGroups(mockGroups);
    }

    // Fetch Functions (unchanged except for logging)
    async function fetchUserDetails() {
        const token = localStorage.getItem('token');
        if (!token) {
            loadMockData();
            return;
        }

        try {
            const res = await fetch('http://localhost:8080/users/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const data = await res.json();
                console.log('User data:', data);
                sidebarName.textContent = data.name || 'Unknown User';
                sidebarDesignation.textContent = data.designation || 'N/A';
                localStorage.setItem('sidebarName', data.name);
                localStorage.setItem('sidebarDesignation', data.designation || 'N/A');
                localStorage.setItem('user_id', data.id);
                userMap.set(data.id, data.name);
            } else {
                console.error('Failed to fetch user details:', res.status);
                loadMockData();
            }
        } catch (err) {
            console.error('Error fetching user details:', err.message);
            loadMockData();
        }
    }

    async function fetchOnlineUsers() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const res = await fetch('http://localhost:8080/users/all-users', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const data = await res.json();
                displayOnlineUsers(data.users || []);
            } else {
                console.error('Failed to fetch online users:', res.status);
                displayOnlineUsers(mockUsers);
            }
        } catch (err) {
            console.error('Error fetching online users:', err.message);
            displayOnlineUsers(mockUsers);
        }
    }

    async function fetchUserGroups() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const res = await fetch('http://localhost:8080/users/user-groups', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
            });
            if (res.ok) {
                const data = await res.json();
                displayUserGroups(data.groups);
            } else {
                console.error('Failed to fetch user groups:', res.status);
                displayUserGroups(mockGroups);
            }
        } catch (err) {
            console.error('Error fetching user groups:', err.message);
            displayUserGroups(mockGroups);
        }
    }

    // Display Functions (unchanged)
    function displayOnlineUsers(users) {
        onlineUsersList.innerHTML = '';
        users.forEach(user => {
            userMap.set(user.id, user.name);
            const li = document.createElement('li');
            li.className = 'flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer';
            li.innerHTML = `
                <span class="w-3 h-3 bg-${user.status === 'online' ? 'green' : 'gray'}-500 rounded-full mr-2"></span>
                <span>${user.name || 'Unknown'}</span>
            `;
            li.dataset.userId = user.id;
            li.addEventListener('click', () => setActiveChat('user', user.id, user.name, user.status));
            onlineUsersList.appendChild(li);
        });
    }

    function displayUserGroups(groups) {
        userGroupsList.innerHTML = '';
        groups.forEach(group => {
            groupMap.set(group.id, group.name);
            const li = document.createElement('li');
            li.className = 'flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer';
            li.innerHTML = `
                <span class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center mr-2">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                </span>
                <span>${group.name || 'Unnamed Group'}</span>
            `;
            li.dataset.groupId = group.id;
            li.addEventListener('click', () => setActiveChat('group', group.id, group.name, group.memberCount || 0));
            userGroupsList.appendChild(li);
        });
    }

    // Set Active Chat (unchanged)
    function setActiveChat(type, id, name, extraInfo) {
        activeChat = { type, id, name };
        console.log('Active chat set:', activeChat);
        const chatHeader = document.querySelector('#chatAreaContainer .bg-gray-200');
        const title = chatHeader.querySelector('h2');
        const subtitle = chatHeader.querySelector('span');
        title.textContent = name;
        subtitle.textContent = type === 'user' ? (extraInfo === 'online' ? 'Online' : 'Offline') : `${extraInfo} members online`;
        chatArea.innerHTML = '';
        loadChatHistory(type, id);
    }

    // Load Chat History (unchanged)
    async function loadChatHistory(type, id) {
        console.log(`Loading history for ${type} ID: ${id}`);
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const res = await fetch(`http://localhost:8080/messages/history?type=${type}&id=${id}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const messages = await res.json();
                messages.forEach(displayMessage);
            } else {
                console.error('Failed to fetch chat history:', res.status);
            }
        } catch (err) {
            console.error('Error fetching chat history:', err.message);
        }
    }

function displayMessage(message) {
    console.log('Attempting to display:', message, 'Active chat:', activeChat);
    if (!activeChat || !activeChat.type) return;

    if (message.error) {
        console.error('Message display failed:', message.error);
        return;
    }

    const isForActiveChat =
        (message.targetType === 'user' && activeChat.type === 'user' &&
         (message.receiver_id === activeChat.id || message.sender_id === activeChat.id)) ||
        (message.targetType === 'group' && activeChat.type === 'group' &&
         message.group_id === activeChat.id);

    if (!isForActiveChat) {
        console.log('Message ignored, not for active chat:', message);
        return;
    }

    if (message.type === 'text') {
        const senderName = userMap.get(message.sender_id) || `User ${message.sender_id}`;
        const isSentByMe = message.sender_id === parseInt(localStorage.getItem('user_id'));
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-4 ${isSentByMe ? 'text-right' : ''}`;
        messageDiv.innerHTML = `
            <p class="text-gray-600 text-sm">${senderName}</p>
            <div class="${isSentByMe ? 'bg-indigo-600 text-white' : 'bg-gray-300'} p-3 rounded-lg inline-block shadow-sm">
                ${message.content || '[Empty Message]'}
            </div>
            <p class="text-gray-500 text-xs mt-1">${new Date(message.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
        `;
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    } else {
        console.error('Unsupported message type:', message.type);
    }
}

    // Display Message
    // function displayMessage(message) {
        console.log('Attempting to display:', message, 'Active chat:', activeChat);
        if (!activeChat || !activeChat.type) return;

        const isForActiveChat =
            (message.targetType === 'user' && activeChat.type === 'user' &&
             (message.receiver_id === activeChat.id || message.sender_id === activeChat.id)) ||
            (message.targetType === 'group' && activeChat.type === 'group' &&
             message.group_id === activeChat.id);

        if (!isForActiveChat) {
            console.log('Message not for active chat:', message);
            return;
        }

        if (message.type === 'text') {
            const senderName = userMap.get(message.sender_id) || `User ${message.sender_id}`;
            const isSentByMe = message.sender_id === parseInt(localStorage.getItem('user_id'));
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-4 ${isSentByMe ? 'text-right' : ''}`;
            messageDiv.innerHTML = `
                <p class="text-gray-600 text-sm">${senderName}</p>
                <div class="${isSentByMe ? 'bg-indigo-600 text-white' : 'bg-gray-300'} p-3 rounded-lg inline-block shadow-sm">
                    ${message.content || '[Empty Message]'}
                </div>
                <p class="text-gray-500 text-xs mt-1">${new Date(message.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
            `;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        } else {
            console.error('Unsupported message type:', message.type);
        }
    
        sendBtn.addEventListener('click', () => {
    console.log('Send button clicked');
    const content = messageInput.value.trim();
    console.log('Message input:', content, 'ActiveChat:', activeChat);
    if (!content) {
        console.log('Empty message entered');
        alert('Please type a message before sending.');
        return;
    }
    if (!activeChat.type || !activeChat.id) {
        console.log('No active chat selected');
        alert('Please select a user or group from the sidebar before sending a message.');
        return;
    }
    const messageData = {
        type: activeChat.type === 'user' ? 'personal_message' : 'group_message',
        [activeChat.type === 'user' ? 'receiver_id' : 'group_id']: activeChat.id,
        content: content
    };
    if (ws && ws.readyState === WebSocket.OPEN) {
        console.log('Sending message:', messageData);
        ws.send(JSON.stringify(messageData));
    } else {
        console.log('WebSocket not open, displaying locally');
        displayMessage({
            sender_id: parseInt(localStorage.getItem('user_id')),
            type: 'text',
            targetType: activeChat.type,
            [activeChat.type === 'user' ? 'receiver_id' : 'group_id']: activeChat.id,
            content: content,
            created_at: new Date().toISOString()
        });
    }
    messageInput.value = '';
});
    // Send Message (Fixed)
    // sendBtn.addEventListener('click', () => {
    //     console.log('Send button clicked');
    //     const content = messageInput.value.trim();
    //     console.log('Message input:', content, 'ActiveChat:', activeChat);
    //     if (content && activeChat.type && activeChat.id) {
    //         const messageData = {
    //             type: activeChat.type === 'user' ? 'personal_message' : 'group_message',
    //             [activeChat.type === 'user' ? 'receiver_id' : 'group_id']: activeChat.id,
    //             content: content
    //         };
    //         if (ws && ws.readyState === WebSocket.OPEN) {
    //             console.log('Sending message:', messageData);
    //             ws.send(JSON.stringify(messageData));
    //         } else {
    //             console.log('WebSocket not open, displaying locally');
    //             displayMessage({
    //                 sender_id: parseInt(localStorage.getItem('user_id')),
    //                 type: 'text',
    //                 targetType: activeChat.type,
    //                 [activeChat.type === 'user' ? 'receiver_id' : 'group_id']: activeChat.id,
    //                 content: content,
    //                 created_at: new Date().toISOString()
    //             });
    //         }
    //         messageInput.value = '';
    //     } else {
    //         alert('Please select a user or group and type a message.');
    //         console.log('No active chat or empty message:', activeChat, content);
    //     }
    // });

    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendBtn.click();
    });

    // Other Event Listeners (unchanged)
    emojiBtn.addEventListener('click', () => {
        messageInput.value += '😊';
        messageInput.focus();
    });

    mediaBtn.addEventListener('click', () => {
        alert('Media upload feature coming soon!');
    });

    voiceChatBtn.addEventListener('click', () => {
        alert('Voice chat feature coming soon!');
    });

    logoutButton.addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('profilePhoto');
        localStorage.removeItem('sidebarName');
        localStorage.removeItem('sidebarDesignation');
        localStorage.removeItem('user_id');
        alert('Logged out successfully!');
        if (ws) ws.close();
        window.location.href = '/users/login';
    });

    menuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('open');
        const chatAreaContainer = document.getElementById('chatAreaContainer');
        if (sidebar.classList.contains('open')) {
            chatAreaContainer.style.marginLeft = '256px';
        } else {
            chatAreaContainer.style.marginLeft = '0';
        }
    });

    const savedPhoto = localStorage.getItem('profilePhoto');
    if (savedPhoto) {
        sidebarProfilePhoto.src = savedPhoto;
        sidebarProfilePhoto.onerror = () => {
            sidebarProfilePhoto.src = 'https://via.placeholder.com/48';
        };
    }

    // Initial Setup (unchanged)
    document.addEventListener('DOMContentLoaded', () => {
        if (!sendBtn || !messageInput || !sidebarName || !chatArea || !onlineUsersList || !userGroupsList) {
            console.error('Missing required DOM elements');
            return;
        }
        connectWebSocket();
    });
</script>