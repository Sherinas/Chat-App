<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectSphere - Chat Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom background lines */
        .background-lines {
            position: absolute;
            inset: 0;
            overflow: hidden;
            z-index: 0;
        }
        .line {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            transform-origin: center;
        }
        .line-1 { width: 200%; height: 1px; top: 20%; left: -50%; transform: rotate(45deg); animation: moveLine1 10s linear infinite; }
        .line-2 { width: 200%; height: 1px; bottom: 20%; left: -50%; transform: rotate(-45deg); animation: moveLine2 12s linear infinite; }
        .line-3 { width: 1px; height: 200%; left: 30%; top: -50%; transform: rotate(30deg); animation: moveLine3 8s linear infinite; }

        @keyframes moveLine1 { 0% { transform: rotate(45deg) translateX(-100%); } 100% { transform: rotate(45deg) translateX(100%); } }
        @keyframes moveLine2 { 0% { transform: rotate(-45deg) translateX(100%); } 100% { transform: rotate(-45deg) translateX(-100%); } }
        @keyframes moveLine3 { 0% { transform: rotate(30deg) translateY(-100%); } 100% { transform: rotate(30deg) translateY(100%); } }

        .logo-animation { animation: rotateFlip 4s ease-in-out infinite; }
        @keyframes rotateFlip {
            0% { transform: rotate(0deg) scaleX(1); } 25% { transform: rotate(90deg) scaleX(1); }
            50% { transform: rotate(180deg) scaleX(-1); } 75% { transform: rotate(270deg) scaleX(-1); }
            100% { transform: rotate(360deg) scaleX(1); }
        }

        .chat-area::-webkit-scrollbar { width: 6px; }
        .chat-area::-webkit-scrollbar-track { background: transparent; }
        .chat-area::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 3px; }
        .chat-area::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        .sidebar { transition: transform 0.3s ease-in-out; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); position: fixed; z-index: 50; }
            .sidebar.open { transform: translateX(0); }
            .chat-area { margin-left: 0 !important; }
            #chatAreaContainer { padding-bottom: 60px; } /* Ensure input bar is accessible on mobile */
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            border-radius: 9999px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
        }

        .message-bubble {
            max-width: 60%;
            display: inline-block;
            padding: 8px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            position: relative;
        }

        .tick {
            font-size: 12px;
            color: #4fc3f7;
            margin-left: 5px;
        }

        .sent .tick {
            position: absolute;
            right: 8px;
            bottom: 2px;
        }

        .forward-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            padding: 2px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            display: none;
        }
        .message-bubble:hover .forward-btn { display: block; }

        /* Recording Animation */
        .recording-animation {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }
        .emoji-modal-content { max-height: 300px; }
    </style>
</head>
<body class="min-h-screen flex bg-gray-100">
    <!-- Background Lines -->
    <div class="background-lines">
        <div class="line line-1"></div>
        <div class="line line-2"></div>
        <div class="line line-3"></div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar w-64 p-4 flex flex-col h-screen bg-gray-800 text-white shadow-lg z-10">
        <div class="flex items-center mb-6">
            <a href="/users/profile" class="flex items-center">
                <div class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center mr-3 logo-animation">
                    <img id="sidebarProfilePhoto" src="" alt="Profile Photo" class="w-full h-full rounded-full object-cover">
                </div>
                <div>
                    <h2 id="sidebarName" class="text-lg font-semibold">John Doe</h2>
                    <p id="sidebarDesignation" class="text-sm text-gray-400">Software Engineer</p>
                </div>
            </a>
        </div>
        <div class="mb-6">
            <input id="searchInput" type="text" placeholder="Search employees or groups..." class="w-full px-3 py-2 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
        </div>
        <div class="mb-6">
            <h3 class="text-sm font-semibold text-gray-400 mb-2 flex items-center">
                Employees
                <button id="chatStatusBtn" class="ml-2 p-1 bg-gray-700 rounded text-xs hover:bg-gray-600">Toggle Status</button>
            </h3>
            <ul id="onlineUsersList" class="space-y-2 max-h-48 overflow-y-auto"></ul>
        </div>
        <div>
            <h3 class="text-sm font-semibold text-gray-400 mb-2">GROUPS</h3>
            <ul id="userGroupsList" class="space-y-2"></ul>
        </div>
    </div>

    <!-- Chat Area -->
    <div id="chatAreaContainer" class="flex-1 flex flex-col h-screen bg-gray-100 text-gray-900 relative z-0">
        <div class="bg-gray-200 p-4 flex items-center justify-between shadow-md">
            <div class="flex items-center">
                <button id="menuBtn" class="md:hidden p-2 text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <h2 id="chatHeader" class="text-lg font-semibold">Select a chat</h2>
                <span id="chatSubHeader" class="ml-2 text-sm text-gray-500"></span>
            </div>
            <div class="relative flex items-center space-x-2">
                <button id="notificationBtn" class="p-2 text-gray-600 hover:text-indigo-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span id="notificationBadge" class="notification-badge hidden">0</span>
                </button>
                <button id="logoutBtn" class="p-2 text-gray-600 hover:text-indigo-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div id="chatArea" class="flex-1 p-4 overflow-y-auto chat-area"></div>
        <div class="bg-gray-200 p-4 flex items-center shadow-md fixed bottom-0 w-full md:w-auto md:static">
            <button id="emojiBtn" class="p-2 text-gray-600 hover:text-indigo-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </button>
            <button id="micBtn" class="p-2 text-gray-600 hover:text-indigo-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3zM6 10a6 6 0 0112 0M6 10V8m12 2V8m-3 10a3 3 0 01-6 0H6a6 6 0 0012 0h-3z"></path>
                </svg>
                <span id="recordingIndicator" class="ml-1 text-red-500 hidden">‚óè</span>
            </button>
            <button id="attachmentBtn" class="p-2 text-gray-600 hover:text-indigo-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.586-6.586a4 4 0 00-5.656-5.656L5.757 10.757a6 6 0 108.486 8.486L21 12"></path>
                </svg>
            </button>
            <input 
                type="text" 
                id="messageInput" 
                class="flex-1 px-4 py-2 bg-gray-300 border border-gray-400 rounded-lg text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                placeholder="Type your message..."
            >
            <button id="sendBtn" class="p-2 bg-indigo-600 hover:bg-indigo-700 rounded-full ml-2">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Attachment Modal -->
    <div id="attachmentModal" class="modal">
        <div class="modal-content">
            <span class="close">√ó</span>
            <h2 class="text-lg font-semibold mb-4">Select Attachment</h2>
            <ul class="space-y-2">
                <li class="p-2 hover:bg-gray-100 cursor-pointer">Picture</li>
                <li class="p-2 hover:bg-gray-100 cursor-pointer">Document</li>
                <li class="p-2 hover:bg-gray-100 cursor-pointer">Video</li>
            </ul>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <span class="close">√ó</span>
            <h2 class="text-lg font-semibold mb-4">Notifications</h2>
            <ul id="notificationList" class="space-y-2"></ul>
        </div>
    </div>

    <!-- Emoji Modal -->
    <div id="emojiModal" class="modal">
        <div class="modal-content emoji-modal-content">
            <span class="close">√ó</span>
            <h2 class="text-lg font-semibold mb-4">Select Emoji</h2>
            <div id="emojiList" class="grid grid-cols-6 gap-2"></div>
        </div>
    </div>

    <!-- Forward Modal -->
    <div id="forwardModal" class="modal">
        <div class="modal-content">
            <span class="close">√ó</span>
            <h2 class="text-lg font-semibold mb-4">Forward to</h2>
            <ul id="forwardList" class="space-y-2"></ul>
        </div>
    </div>

    <!-- JavaScript -->
   <!-- ... (Keep the existing HTML and CSS unchanged) ... -->

<!-- JavaScript -->
<script>
    // Mock data for development
    const mockUsers = [
        { id: 1, name: "Alice Smith", status: "online" },
        { id: 2, name: "Bob Johnson", status: "online" },
        { id: 3, name: "Alan", status: "offline" },
        { id: 5, name: "Sujith", status: "online" }
    ];
    const mockGroups = [
        { id: 1, name: "Engineering Team", memberCount: 5 },
        { id: 2, name: "Marketing Team", memberCount: 3 }
    ];
    const mockNotifications = [];
    const mockMessageHistory = new Map(); // Store history per chat
    const emojis = ['üòä', 'üòÇ', '‚ù§Ô∏è', 'üëç', 'üò¢', 'üòç', 'üò¥', 'ü§î', 'üòé', 'üëã', 'üéâ', 'üöÄ'];

    // DOM Elements
    const menuBtn = document.getElementById('menuBtn');
    const sidebar = document.getElementById('sidebar');
    const chatArea = document.getElementById('chatArea');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const emojiBtn = document.getElementById('emojiBtn');
    const micBtn = document.getElementById('micBtn');
    const attachmentBtn = document.getElementById('attachmentBtn');
    const voiceChatBtn = document.getElementById('voiceChatBtn');
    const sidebarName = document.getElementById('sidebarName');
    const sidebarDesignation = document.getElementById('sidebarDesignation');
    const onlineUsersList = document.getElementById('onlineUsersList');
    const userGroupsList = document.getElementById('userGroupsList');
    const sidebarProfilePhoto = document.getElementById('sidebarProfilePhoto');
    const chatHeader = document.getElementById('chatHeader');
    const chatSubHeader = document.getElementById('chatSubHeader');
    const recordingIndicator = document.getElementById('recordingIndicator');
    const attachmentModal = document.getElementById('attachmentModal');
    const notificationBtn = document.getElementById('notificationBtn');
    const notificationModal = document.getElementById('notificationModal');
    const notificationList = document.getElementById('notificationList');
    const chatStatusBtn = document.getElementById('chatStatusBtn');
    const searchInput = document.getElementById('searchInput');
    const emojiModal = document.getElementById('emojiModal');
    const emojiList = document.getElementById('emojiList');
    const forwardModal = document.getElementById('forwardModal');
    const forwardList = document.getElementById('forwardList');
    const logoutBtn = document.getElementById('logoutBtn');
    const notificationBadge = document.getElementById('notificationBadge');

    // Global Variables
    let ws;
    let activeChat = null;
    let isRecording = false;
    const userMap = new Map();
    let mediaRecorder;
    let audioChunks = [];
    let unreadMessages = new Set(); // Track unread messages

    // Initialize on Page Load
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Page loaded, initializing...');
        chatArea.innerHTML = ''; // Clear chat area
        const savedPhoto = localStorage.getItem('profilePhoto');
        if (savedPhoto) {
            sidebarProfilePhoto.src = savedPhoto;
            sidebarProfilePhoto.onerror = () => { sidebarProfilePhoto.src = 'https://via.placeholder.com/48'; };
        } else {
            console.log('No profile photo in localStorage');
        }
        connectWebSocket();
        logUserDetails();
        loadMockData();
        displayNotifications(mockNotifications);
        setupSearch();
        populateEmojis();
        const initialGroupId = 5; // Known group ID
        const initialGroupName = 'Tech support team';
        setActiveChat('group', initialGroupId, initialGroupName, initialGroupId === 5 ? 10 : 0); // Example member count
        fetchMessageHistory(initialGroupId, 'group'); // Load initial history
        console.log('Initialization complete, activeChat:', activeChat);
    });

    // Log User Details for Debugging
    function logUserDetails() {
        let userId = localStorage.getItem('user_id');
        if (!userId || isNaN(parseInt(userId))) {
            userId = prompt('Enter your user ID (e.g., 3 for Alan, 5 for Sujith):') || '0';
            localStorage.setItem('user_id', userId);
            console.warn('User ID not found or invalid, set to:', userId);
        }
        userId = parseInt(userId);
        console.log('Current User ID from localStorage:', userId);
        console.log('Active Chat:', activeChat);
    }

    // Sidebar Toggle for Mobile
    menuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('open');
        console.log('Sidebar toggled, state:', sidebar.classList.contains('open'));
    });

    // WebSocket Connection
    function connectWebSocket() {
        if (ws && ws.readyState === WebSocket.OPEN) {
            console.log('WebSocket already connected');
            return;
        }
        const token = localStorage.getItem('token');
        const userId = localStorage.getItem('user_id');
        console.log('Connecting WebSocket - Token:', token, 'User ID:', userId);
        if (!token || !userId) {
            console.warn('No token or user ID found. Using mock data or requiring login.');
            loadMockData();
            return;
        }
        ws = new WebSocket(`ws://localhost:8081/ws/chat?token=${token}`);

        ws.onopen = () => {
            console.log('WebSocket opened for User:', userId);
            fetchUserDetails();
            fetchOnlineUsers();
            fetchUserGroups();
            sendStatusUpdate(true); // Set status to online
        };

        ws.onmessage = (event) => {
            console.log('Raw WebSocket data received:', event.data);
            try {
                const message = JSON.parse(event.data);
                console.log('Parsed message:', message);
                if (message.error) {
                    console.error('WebSocket error:', message.error);
                    return;
                }
                const currentUserId = parseInt(localStorage.getItem('user_id')) || 0;
                if (message.sender_id !== currentUserId) {
                    unreadMessages.add(JSON.stringify(message)); // Add to unread
                    updateNotificationBadge();
                }
                if (message.sender_id === currentUserId && message.status === 'sent') {
                    message.status = 'delivered'; // Update to delivered locally
                }
                displayMessage(message);
            } catch (err) {
                console.error('Error parsing WebSocket message:', err, 'Raw data:', event.data);
            }
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };

        ws.onclose = () => {
            console.log('WebSocket closed, reconnecting...');
            setTimeout(connectWebSocket, 3000);
        };
    }

    function setActiveChat(chatType, chatId, chatName, extraInfo) {
        activeChat = { type: chatType, id: chatId, name: chatName };
        console.log('Active chat set to:', activeChat, 'Extra Info:', extraInfo);
        chatHeader.textContent = chatName || 'Unknown Chat';
        chatSubHeader.textContent = chatType === 'user' ? (extraInfo === 'online' ? 'Online' : 'Offline') : `${extraInfo || 0} members`;
        chatArea.innerHTML = ''; // Clear chat area before loading history
        fetchMessageHistory(chatId, chatType); // Load message history
        markMessagesAsSeen(chatId, chatType); // Mark messages as seen
        logUserDetails();
        if (chatType === 'group' && ws) {
            connectWebSocket(); // Reconnect with group_id
        }
    }

    // Load Mock Data
    function loadMockData() {
        sidebarName.textContent = localStorage.getItem('sidebarName') || 'John Doe';
        sidebarDesignation.textContent = localStorage.getItem('sidebarDesignation') || 'Software Engineer';
        displayOnlineUsers(mockUsers);
        displayUserGroups(mockGroups);
        console.log('Mock data loaded');
    }

    // Fetch User Details
    async function fetchUserDetails() {
        const token = localStorage.getItem('token');
        if (!token) return;
        try {
            const res = await fetch('http://localhost:8080/users/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const data = await res.json();
                sidebarName.textContent = data.name || 'Unknown User';
                sidebarDesignation.textContent = data.designation || 'N/A';
                localStorage.setItem('sidebarName', data.name);
                localStorage.setItem('sidebarDesignation', data.designation || 'N/A');
                localStorage.setItem('user_id', data.id);
                console.log('Fetched User Details:', data);
            } else {
                console.error('Failed to fetch user details:', res.status);
                loadMockData();
            }
        } catch (err) {
            console.error('Error fetching user details:', err);
            loadMockData();
        }
    }

    // Fetch Online Users
    async function fetchOnlineUsers() {
        const token = localStorage.getItem('token');
        if (!token) return;
        try {
            const res = await fetch('http://localhost:8080/users/all-users', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const data = await res.json();
                console.log('Fetched users:', data.users);
                data.users.forEach(user => userMap.set(user.id, user.name));
                displayOnlineUsers(data.users);
            } else {
                console.error('Failed to fetch online users:', res.status);
                displayOnlineUsers(mockUsers);
            }
        } catch (err) {
            console.error('Error fetching online users:', err);
            displayOnlineUsers(mockUsers);
        }
    }

    // Fetch User Groups
    async function fetchUserGroups() {
        const token = localStorage.getItem('token');
        if (!token) return;
        try {
            const res = await fetch('http://localhost:8080/users/user-groups', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const data = await res.json();
                console.log('Fetched groups:', data.groups);
                displayUserGroups(data.groups || []);
            } else {
                console.error('Failed to fetch user groups:', res.status);
                displayUserGroups(mockGroups);
            }
        } catch (err) {
            console.error('Error fetching user groups:', err);
            displayUserGroups(mockGroups);
        }
    }

    // Display Online Users
    function displayOnlineUsers(users) {
        onlineUsersList.innerHTML = '';
        users.forEach(user => {
            const li = document.createElement('li');
            li.className = 'flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer';
            li.innerHTML = `<span class="w-3 h-3 ${user.status === 'online' ? 'bg-green-500' : 'bg-gray-500'} rounded-full mr-2"></span><span>${user.name || 'Unknown'}</span>`;
            li.dataset.userId = user.id;
            li.addEventListener('click', () => setActiveChat('user', user.id, user.name, user.status));
            onlineUsersList.appendChild(li);
        });
        console.log('Online users displayed:', users.length);
    }

    // Display User Groups
    function displayUserGroups(groups) {
        userGroupsList.innerHTML = '';
        groups.forEach(group => {
            const li = document.createElement('li');
            li.className = 'flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer';
            li.innerHTML = `<span class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center mr-2"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></span><span>${group.Name || 'Unnamed Group'}</span>`;
            li.dataset.groupId = group.ID || group.id;
            li.dataset.groupName = group.Name || group.name;
            li.dataset.groupMemberCount = group.memberCount || 'Unknown';
            li.addEventListener('click', () => {
                const id = parseInt(li.dataset.groupId);
                const name = li.dataset.groupName;
                const memberCount = li.dataset.groupMemberCount;
                setActiveChat('group', id, name, memberCount);
            });
            userGroupsList.appendChild(li);
        });
        console.log('User groups displayed:', groups.length);
    }

    // Fetch Message History
    async function fetchMessageHistory(chatId, chatType) {
        const token = localStorage.getItem('token');
        if (!token || !activeChat) {
            console.log('No token or active chat, skipping history fetch');
            return;
        }
        try {
            const url = `http://localhost:8080/messages/history?${chatType}_id=${chatId}`;
            const res = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const messages = await res.json();
                console.log('Fetched message history:', messages);
                mockMessageHistory.set(`${chatType}:${chatId}`, messages);
                messages.forEach(msg => displayMessage(msg));
            } else {
                console.error('Failed to fetch message history:', res.status);
                const mockHistory = [
                    { sender_id: 1, content: 'Hello!', created_at: '2025-04-10 10:00', status: 'seen', type: 'text', targetType: chatType, [chatType === 'user' ? 'receiver_id' : 'group_id']: chatId },
                    { sender_id: 2, content: 'Hi there!', created_at: '2025-04-10 10:05', status: 'delivered', type: 'text', targetType: chatType, [chatType === 'user' ? 'receiver_id' : 'group_id']: chatId }
                ];
                mockMessageHistory.set(`${chatType}:${chatId}`, mockHistory);
                mockHistory.forEach(msg => displayMessage(msg));
            }
        } catch (err) {
            console.error('Error fetching message history:', err);
        }
    }

    // Display Message with Reply and Forward
    const displayedMessages = new Map();
    function displayMessage(message) {
        console.log('Displaying message:', message, 'Active chat:', activeChat);
        if (!activeChat || !activeChat.type || !activeChat.id) {
            console.log('No active chat defined, skipping display');
            return;
        }
        const currentUserId = parseInt(localStorage.getItem('user_id')) || 0;
        console.log('Current User ID:', currentUserId, 'Message Sender ID:', message.sender_id);

        const messageKey = message.tempId || `${message.sender_id}-${message.created_at}-${message.content}`;
        if (displayedMessages.has(messageKey)) {
            console.log('Duplicate message skipped:', messageKey);
            return;
        }
        displayedMessages.set(messageKey, message);

        const isForActiveChat = 
            (message.targetType === 'user' && activeChat.type === 'user' && 
             (message.receiver_id === activeChat.id || message.sender_id === activeChat.id || message.sender_id === currentUserId)) ||
            (message.targetType === 'group' && activeChat.type === 'group' && message.group_id === activeChat.id);
        console.log('isForActiveChat:', isForActiveChat);

        if (!isForActiveChat) {
            console.log('Message not for active chat, skipping');
            return;
        }

        const isSentByMe = message.sender_id === currentUserId;
        const senderName = userMap.get(message.sender_id) || `User ${message.sender_id}`;
        const status = message.status || 'sent';
        let tickIcon = '';
        if (isSentByMe) {
            tickIcon = status === 'seen' ? '‚úì‚úì' : (status === 'delivered' ? '‚úì' : '');
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-4 ${isSentByMe ? 'text-right' : 'text-left'} relative`;
        let contentHTML = '';

        if (message.type === 'text') {
            contentHTML = message.content || '[Empty Message]';
        } else if (message.type === 'audio_message') {
            contentHTML = `<audio controls src="data:audio/webm;base64,${message.content || ''}"></audio>`;
        } else if (message.type === 'file_message') {
            contentHTML = `<a href="data:${message.filetype || 'application/octet-stream'};base64,${message.content || ''}" download="${message.filename || 'unknown_file'}" class="text-blue-500 underline">${message.filename || 'Unknown File'}</a>`;
        }

        messageDiv.innerHTML = `
            <p class="text-gray-600 text-sm">${activeChat.type === 'group' ? senderName : (isSentByMe ? '' : senderName)}</p>
            <div class="message-bubble relative ${isSentByMe ? 'bg-indigo-600 text-white' : 'bg-gray-300'}">
                ${contentHTML}
                ${isSentByMe ? `<span class="tick">${tickIcon}</span>` : ''}
                <div class="flex space-x-2 mt-1">
                    <button class="reply-btn text-xs text-blue-500 hover:underline" data-message-id="${messageKey}">Reply</button>
                    <button class="forward-btn text-xs text-green-500 hover:underline" onclick="showForwardModal('${encodeURIComponent(message.content || '')}', '${messageKey}')">Forward</button>
                </div>
            </div>
            <p class="text-gray-500 text-xs mt-1">${new Date(message.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
        `;
        chatArea.appendChild(messageDiv); // Ensure message is added to DOM
        chatArea.scrollTop = chatArea.scrollHeight; // Scroll to latest message
        console.log('Message displayed in chatArea, count:', chatArea.childElementCount);
    }

    // Send Message with Status Tracking
    sendBtn.addEventListener('click', () => {
        console.log('Send button clicked');
        const content = messageInput.value.trim();
        console.log('Message content:', content);
        if (!content) {
            console.log('Empty message');
            alert('Please type a message before sending.');
            return;
        }
        if (!activeChat || !activeChat.type || !activeChat.id) {
            console.log('No active chat');
            alert('Please select a user or group from the sidebar.');
            return;
        }
        const currentUserId = parseInt(localStorage.getItem('user_id'));
        if (isNaN(currentUserId)) {
            console.error('Invalid user_id');
            localStorage.setItem('user_id', prompt('Enter your user ID:') || 0);
            return;
        }
        const tempMessageId = Date.now();
        const messageData = {
            type: activeChat.type === 'user' ? 'personal_message' : 'group_message',
            targetType: activeChat.type,
            [activeChat.type === 'user' ? 'receiver_id' : 'group_id']: activeChat.id,
            content: content,
            tempId: tempMessageId,
            status: 'sent',
            sender_id: currentUserId
        };
        const localMessage = {
            sender_id: currentUserId,
            type: 'text',
            targetType: activeChat.type,
            [activeChat.type === 'user' ? 'receiver_id' : 'activeChat.id'] : activeChat.id,
            content: content,
            created_at: new Date().toISOString(),
            tempId: tempMessageId,
            status: 'sent'
        };
        console.log('Sending message:', messageData);
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(messageData));
            console.log('Message sent via WebSocket');
        } else {
            console.log('WebSocket not open, displaying locally');
        }
        displayMessage(localMessage);
        messageInput.value = '';
    });

    // Mic Button for Recording
    micBtn.addEventListener('click', async () => {
        if (!isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onload = () => sendMultimediaMessage('audio_message', reader.result.split(',')[1], null, null, 'audio.webm', 'audio/webm');
                    reader.readAsDataURL(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                    isRecording = false;
                    recordingIndicator.classList.add('hidden');
                    recordingIndicator.classList.remove('recording-animation');
                };
                mediaRecorder.start();
                isRecording = true;
                recordingIndicator.classList.remove('hidden');
                recordingIndicator.classList.add('recording-animation');
                setTimeout(() => mediaRecorder.stop(), 5000);
            } catch (err) {
                console.error('Microphone access denied:', err);
                alert('Microphone access is required.');
            }
        } else {
            mediaRecorder.stop();
        }
    });

    // Attachment Modal and File Upload
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.id = 'fileInput';
    fileInput.style.display = 'none';
    fileInput.accept = 'image/*,video/*,application/*';
    fileInput.multiple = true;
    document.body.appendChild(fileInput);
    attachmentBtn.addEventListener('click', () => {
        attachmentModal.style.display = 'block';
        console.log('Attachment modal opened');
    });
    document.querySelectorAll('#attachmentModal li').forEach(item => {
        item.addEventListener('click', () => {
            fileInput.click();
            attachmentModal.style.display = 'none';
        });
    });
    fileInput.addEventListener('change', (event) => {
        const files = event.target.files;
        if (!files.length) {
            console.log('No files selected');
            alert('Please select a file.');
            return;
        }
        for (const file of files) {
            const reader = new FileReader();
            reader.onload = () => sendMultimediaMessage('file_message', reader.result.split(',')[1], null, null, file.name, file.type);
            reader.readAsDataURL(file);
        }
        event.target.value = '';
    });

    // Notification Modal
    notificationBtn.addEventListener('click', () => {
        notificationModal.style.display = 'block';
        notificationList.innerHTML = '';
        unreadMessages.forEach(msg => {
            const message = JSON.parse(msg);
            const li = document.createElement('li');
            li.className = 'p-2 hover:bg-gray-100';
            li.innerHTML = `<span>${userMap.get(message.sender_id) || 'Unknown'} says: ${message.content}</span>`;
            notificationList.appendChild(li);
        });
        unreadMessages.clear();
        updateNotificationBadge();
        console.log('Notification modal opened, cleared unread:', unreadMessages.size);
    });

    function updateNotificationBadge() {
        const count = unreadMessages.size;
        notificationBadge.textContent = count;
        notificationBadge.classList.toggle('hidden', count === 0);
        console.log('Notification badge updated, count:', count);
    }

    function displayNotifications(notifications) {
        notificationList.innerHTML = '';
        notifications.forEach(notif => {
            const li = document.createElement('li');
            li.className = 'p-2 hover:bg-gray-100';
            li.innerHTML = `<span>${notif.message}</span><span class="text-xs text-gray-500 ml-2">${notif.time}</span>`;
            notificationList.appendChild(li);
        });
    }

    // Emoji Modal
    function populateEmojis() {
        emojis.forEach(emoji => {
            const span = document.createElement('span');
            span.className = 'text-2xl cursor-pointer hover:bg-gray-200 p-2 rounded';
            span.textContent = emoji;
            span.addEventListener('click', () => {
                messageInput.value += emoji;
                emojiModal.style.display = 'none';
                messageInput.focus();
            });
            emojiList.appendChild(span);
        });
    }
    emojiBtn.addEventListener('click', () => {
        emojiModal.style.display = 'block';
        console.log('Emoji modal opened');
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('profilePhoto');
        localStorage.removeItem('user_id');
        alert('Logged out successfully!');
        window.location.href = '/auth/login';
        loadMockData();
        console.log('Logged out');
    });

    // Chat Status Button
    let isOnline = true;
    chatStatusBtn.addEventListener('click', () => {
        isOnline = !isOnline;
        chatStatusBtn.textContent = isOnline ? 'Go Offline' : 'Go Online';
        chatStatusBtn.classList.toggle('bg-green-500', isOnline);
        chatStatusBtn.classList.toggle('bg-red-500', !isOnline);
        sendStatusUpdate(isOnline);
        if (isOnline) fetchUnreadMessages(); // Load unread messages when going online
        console.log('Status toggled to:', isOnline ? 'online' : 'offline');
    });

    function sendStatusUpdate(status) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: 'status_update', status: status ? 'online' : 'offline' }));
            console.log('Sent status update:', status);
        }
    }

    async function fetchUnreadMessages() {
        const token = localStorage.getItem('token');
        if (!token) return;
        try {
            const res = await fetch('http://localhost:8080/messages/unread', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const messages = await res.json();
                console.log('Fetched unread messages:', messages);
                messages.forEach(msg => displayMessage(msg));
            } else {
                console.error('Failed to fetch unread messages:', res.status);
                const mockUnread = [{ sender_id: 1, content: 'Missed you!', created_at: '2025-04-11 14:00', status: 'sent', type: 'text', targetType: 'user', receiver_id: parseInt(localStorage.getItem('user_id')) }];
                mockUnread.forEach(msg => displayMessage(msg));
            }
        } catch (err) {
            console.error('Error fetching unread messages:', err);
        }
    }

    // Search Functionality
    function setupSearch() {
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            fetchOnlineUsers().then(() => {
                const users = [...mockUsers];
                const filteredUsers = users.filter(user => user.name.toLowerCase().includes(query));
                displayOnlineUsers(filteredUsers);
            });
            fetchUserGroups().then(() => {
                const groups = [...mockGroups];
                const filteredGroups = groups.filter(group => group.name.toLowerCase().includes(query));
                displayUserGroups(filteredGroups);
            });
        });
    }

    // Forward Modal
    window.showForwardModal = function(content, messageKey) {
        forwardList.innerHTML = '';
        [...mockUsers, ...mockGroups.map(g => ({ id: g.id, name: g.name, status: 'group' }))].forEach(target => {
            const li = document.createElement('li');
            li.className = 'p-2 hover:bg-gray-100 cursor-pointer';
            li.innerHTML = `<span>${target.name} ${target.status === 'group' ? '(Group)' : (target.status === 'online' ? '(Online)' : '(Offline)')}</span>`;
            li.addEventListener('click', () => {
                console.log(`Forwarding "${content}" to ${target.name}`);
                const forwardMessage = {
                    type: target.status === 'group' ? 'group_message' : 'personal_message',
                    targetType: target.status === 'group' ? 'group' : 'user',
                    [target.status === 'group' ? 'group_id' : 'receiver_id']: target.id,
                    content: decodeURIComponent(content),
                    created_at: new Date().toISOString(),
                    sender_id: parseInt(localStorage.getItem('user_id')),
                    status: 'sent'
                };
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(forwardMessage));
                    displayMessage(forwardMessage);
                }
                forwardModal.style.display = 'none';
            });
            forwardList.appendChild(li);
        });
        forwardModal.style.display = 'block';
        console.log('Forward modal opened');
    };

    // Multimedia Message Sending
    function sendMultimediaMessage(type, content, receiverId, groupId, filename, filetype) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            console.log('WebSocket not open, reconnecting...');
            connectWebSocket();
            return;
        }
        const senderId = parseInt(localStorage.getItem('user_id'));
        const messageData = {
            type: type,
            sender_id: senderId,
            content: content || '',
            filename: filename || null,
            filetype: filetype || null,
            targetType: activeChat.type,
            ...(activeChat.type === 'user' ? { receiver_id: activeChat.id } : { group_id: activeChat.id })
        };
        console.log('Sending multimedia message:', messageData);
        ws.send(JSON.stringify(messageData));
        const localMessage = {
            sender_id: senderId,
            type: type,
            targetType: activeChat.type,
            [activeChat.type === 'user' ? 'receiver_id' : 'group_id']: activeChat.id,
            content: type === 'audio_message' ? '[Audio Message]' : '[File Message]',
            created_at: new Date().toISOString(),
            tempId: Date.now(),
            status: 'sent'
        };
        displayMessage(localMessage);
    }

    // Mark Messages as Seen
    function markMessagesAsSeen(chatId, chatType) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'mark_seen',
                targetType: chatType,
                [chatType === 'user' ? 'receiver_id' : 'group_id']: chatId,
                sender_id: parseInt(localStorage.getItem('user_id'))
            }));
            console.log('Marking messages as seen for chat:', chatId, chatType);
            document.querySelectorAll('.message-bubble').forEach(div => {
                const message = displayedMessages.get(div.querySelector('.reply-btn')?.dataset.messageId);
                if (message && message.sender_id !== parseInt(localStorage.getItem('user_id'))) {
                    message.status = 'seen';
                    if (div.querySelector('.tick')) {
                        div.querySelector('.tick').textContent = '‚úì‚úì';
                    }
                }
            });
        }
    }

    // Close Modals
    document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', () => {
            attachmentModal.style.display = 'none';
            notificationModal.style.display = 'none';
            emojiModal.style.display = 'none';
            forwardModal.style.display = 'none';
            console.log('Modal closed');
        });
    });
    window.addEventListener('click', (e) => {
        if (e.target === attachmentModal) attachmentModal.style.display = 'none';
        if (e.target === notificationModal) notificationModal.style.display = 'none';
        if (e.target === emojiModal) emojiModal.style.display = 'none';
        if (e.target === forwardModal) forwardModal.style.display = 'none';
    });
</script>
</body>
</html>