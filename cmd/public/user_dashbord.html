<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectSphere - Chat Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom background lines */
        .background-lines {
            position: absolute;
            inset: 0;
            overflow: hidden;
            z-index: 0;
        }
        .line {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            transform-origin: center;
        }
        .line-1 { width: 200%; height: 1px; top: 20%; left: -50%; transform: rotate(45deg); animation: moveLine1 10s linear infinite; }
        .line-2 { width: 200%; height: 1px; bottom: 20%; left: -50%; transform: rotate(-45deg); animation: moveLine2 12s linear infinite; }
        .line-3 { width: 1px; height: 200%; left: 30%; top: -50%; transform: rotate(30deg); animation: moveLine3 8s linear infinite; }

        @keyframes moveLine1 { 0% { transform: rotate(45deg) translateX(-100%); } 100% { transform: rotate(45deg) translateX(100%); } }
        @keyframes moveLine2 { 0% { transform: rotate(-45deg) translateX(100%); } 100% { transform: rotate(-45deg) translateX(-100%); } }
        @keyframes moveLine3 { 0% { transform: rotate(30deg) translateY(-100%); } 100% { transform: rotate(30deg) translateY(100%); } }

        .logo-animation { animation: rotateFlip 4s ease-in-out infinite; }
        @keyframes rotateFlip {
            0% { transform: rotate(0deg) scaleX(1); } 25% { transform: rotate(90deg) scaleX(1); }
            50% { transform: rotate(180deg) scaleX(-1); } 75% { transform: rotate(270deg) scaleX(-1); }
            100% { transform: rotate(360deg) scaleX(1); }
        }

        .chat-area::-webkit-scrollbar { width: 6px; }
        .chat-area::-webkit-scrollbar-track { background: transparent; }
        .chat-area::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 3px; }
        .chat-area::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        .sidebar { transition: transform 0.3s ease-in-out; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); position: fixed; z-index: 50; }
            .sidebar.open { transform: translateX(0); }
            .chat-area { margin-left: 0 !important; }
            #chatAreaContainer { padding-bottom: 60px; } /* Ensure input bar is accessible on mobile */
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            border-radius: 9999px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
        }

        .message-bubble {
            max-width: 60%;
            display: inline-block;
            padding: 8px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            position: relative;
        }

        .tick {
            font-size: 12px;
            color: #4fc3f7;
            margin-left: 5px;
        }

        .sent .tick {
            position: absolute;
            right: 8px;
            bottom: 2px;
        }

        .forward-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            padding: 2px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            display: none;
        }
        .message-bubble:hover .forward-btn { display: block; }

        /* Recording Animation */
        .recording-animation {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }
        .emoji-modal-content { max-height: 300px; }
    </style>
</head>
<body class="min-h-screen flex bg-gray-100">
    <!-- Background Lines -->
    <div class="background-lines">
        <div class="line line-1"></div>
        <div class="line line-2"></div>
        <div class="line line-3"></div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar w-64 p-4 flex flex-col h-screen bg-gray-800 text-white shadow-lg z-10">
        <div class="flex items-center mb-6">
            <a href="/users/profile" class="flex items-center">
                <div class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center mr-3 logo-animation">
                    <img id="sidebarProfilePhoto" src="" alt="Profile Photo" class="w-full h-full rounded-full object-cover">
                </div>
                <div>
                    <h2 id="sidebarName" class="text-lg font-semibold">John Doe</h2>
                    <p id="sidebarDesignation" class="text-sm text-gray-400">Software Engineer</p>
                </div>
            </a>
        </div>
        <div class="mb-6">
            <input id="searchInput" type="text" placeholder="Search employees or groups..." class="w-full px-3 py-2 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
        </div>
        <div class="mb-6">
            <h3 class="text-sm font-semibold text-gray-400 mb-2 flex items-center">
                Employees
                <button id="chatStatusBtn" class="ml-2 p-1 bg-gray-700 rounded text-xs hover:bg-gray-600">Toggle Status</button>
            </h3>
            <ul id="onlineUsersList" class="space-y-2 max-h-48 overflow-y-auto"></ul>
        </div>
        <div>
            <h3 class="text-sm font-semibold text-gray-400 mb-2">GROUPS</h3>
            <ul id="userGroupsList" class="space-y-2"></ul>
        </div>
    </div>

    <!-- Chat Area -->
    <div id="chatAreaContainer" class="flex-1 flex flex-col h-screen bg-gray-100 text-gray-900 relative z-0">
        <div class="bg-gray-200 p-4 flex items-center justify-between shadow-md">
            <div class="flex items-center">
                <button id="menuBtn" class="md:hidden p-2 text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <h2 id="chatHeader" class="text-lg font-semibold">Select a chat</h2>
                <span id="chatSubHeader" class="ml-2 text-sm text-gray-500"></span>
            </div>
            <div class="relative flex items-center space-x-2">
                <button id="notificationBtn" class="p-2 text-gray-600 hover:text-indigo-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span id="notificationBadge" class="notification-badge hidden">0</span>
                </button>
                <button id="logoutBtn" class="p-2 text-gray-600 hover:text-indigo-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div id="chatArea" class="flex-1 p-4 overflow-y-auto chat-area"></div>
        <div class="bg-gray-200 p-4 flex items-center shadow-md fixed bottom-0 w-full md:w-auto md:static">
            <button id="emojiBtn" class="p-2 text-gray-600 hover:text-indigo-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </button>
            <button id="micBtn" class="p-2 text-gray-600 hover:text-indigo-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3zM6 10a6 6 0 0112 0M6 10V8m12 2V8m-3 10a3 3 0 01-6 0H6a6 6 0 0012 0h-3z"></path>
                </svg>
                <span id="recordingIndicator" class="ml-1 text-red-500 hidden">‚óè</span>
            </button>
            <button id="attachmentBtn" class="p-2 text-gray-600 hover:text-indigo-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.586-6.586a4 4 0 00-5.656-5.656L5.757 10.757a6 6 0 108.486 8.486L21 12"></path>
                </svg>
            </button>
            <input 
                type="text" 
                id="messageInput" 
                class="flex-1 px-4 py-2 bg-gray-300 border border-gray-400 rounded-lg text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                placeholder="Type your message..."
            >
            <button id="sendBtn" class="p-2 bg-indigo-600 hover:bg-indigo-700 rounded-full ml-2">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Attachment Modal -->
    <div id="attachmentModal" class="modal">
        <div class="modal-content">
            <span class="close">√ó</span>
            <h2 class="text-lg font-semibold mb-4">Select Attachment</h2>
            <ul class="space-y-2">
                <li class="p-2 hover:bg-gray-100 cursor-pointer">Picture</li>
                <li class="p-2 hover:bg-gray-100 cursor-pointer">Document</li>
                <li class="p-2 hover:bg-gray-100 cursor-pointer">Video</li>
            </ul>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <span class="close">√ó</span>
            <h2 class="text-lg font-semibold mb-4">Notifications</h2>
            <ul id="notificationList" class="space-y-2"></ul>
        </div>
    </div>

    <!-- Emoji Modal -->
    <div id="emojiModal" class="modal">
        <div class="modal-content emoji-modal-content">
            <span class="close">√ó</span>
            <h2 class="text-lg font-semibold mb-4">Select Emoji</h2>
            <div id="emojiList" class="grid grid-cols-6 gap-2"></div>
        </div>
    </div>

    <!-- Forward Modal -->
    <div id="forwardModal" class="modal">
        <div class="modal-content">
            <span class="close">√ó</span>
            <h2 class="text-lg font-semibold mb-4">Forward to</h2>
            <ul id="forwardList" class="space-y-2"></ul>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Mock data for development
        const mockUsers = [
            { id: 1, name: "Alice Smith", status: "online" },
            { id: 2, name: "Bob Johnson", status: "online" },
            { id: 3, name: "Alan", status: "offline" },
            { id: 5, name: "Sujith", status: "online" }
        ];
        const mockGroups = [
            { id: 1, name: "Engineering Team", memberCount: 5 },
            { id: 2, name: "Marketing Team", memberCount: 3 }
        ];
        const mockNotifications = [
            { id: 1, message: "New message from Alice", time: "2025-04-09 10:00" },
            { id: 2, message: "Group invite from Engineering Team", time: "2025-04-09 09:30" }
        ];
        const emojis = ['üòä', 'üòÇ', '‚ù§Ô∏è', 'üëç', 'üò¢', 'üòç', 'üò¥', 'ü§î', 'üòé', 'üëã', 'üéâ', 'üöÄ'];

        // DOM Elements
        const menuBtn = document.getElementById('menuBtn');
        const sidebar = document.getElementById('sidebar');
        const chatArea = document.getElementById('chatArea');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const emojiBtn = document.getElementById('emojiBtn');
        const micBtn = document.getElementById('micBtn');
        const attachmentBtn = document.getElementById('attachmentBtn');
        const voiceChatBtn = document.getElementById('voiceChatBtn');
        const sidebarName = document.getElementById('sidebarName');
        const sidebarDesignation = document.getElementById('sidebarDesignation');
        const onlineUsersList = document.getElementById('onlineUsersList');
        const userGroupsList = document.getElementById('userGroupsList');
        const sidebarProfilePhoto = document.getElementById('sidebarProfilePhoto');
        const chatHeader = document.getElementById('chatHeader');
        const chatSubHeader = document.getElementById('chatSubHeader');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const attachmentModal = document.getElementById('attachmentModal');
        const notificationBtn = document.getElementById('notificationBtn');
        const notificationModal = document.getElementById('notificationModal');
        const notificationList = document.getElementById('notificationList');
        const chatStatusBtn = document.getElementById('chatStatusBtn');
        const searchInput = document.getElementById('searchInput');
        const emojiModal = document.getElementById('emojiModal');
        const emojiList = document.getElementById('emojiList');
        const forwardModal = document.getElementById('forwardModal');
        const forwardList = document.getElementById('forwardList');
        const logoutBtn = document.getElementById('logoutBtn');

        // Global Variables
        let ws;
        let activeChat = null;
        let isRecording = false;
        const userMap = new Map();

        // Initialize on Page Load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, clearing chat area');
            chatArea.innerHTML = '';
            const savedPhoto = localStorage.getItem('profilePhoto');
            if (savedPhoto) {
                sidebarProfilePhoto.src = savedPhoto;
                sidebarProfilePhoto.onerror = () => { sidebarProfilePhoto.src = 'https://via.placeholder.com/48'; };
            }
            connectWebSocket();
            logUserDetails();
            loadMockData();
            displayNotifications(mockNotifications);
            setupSearch();
            populateEmojis();
        });

        // Log User Details for Debugging
        function logUserDetails() {
            const userId = localStorage.getItem('user_id');
            console.log('Current User ID from localStorage:', userId, 'Parsed:', parseInt(userId));
            console.log('Active Chat:', activeChat);
        }

        // Sidebar Toggle for Mobile
        menuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        // // WebSocket Connection
     
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log('WebSocket already connected');
                return;
            }
            const token = localStorage.getItem('token');
            const userId = localStorage.getItem('user_id');
            console.log('Connecting WebSocket - Token:', token, 'User ID:', userId);
            if (!token || !userId) {
                console.warn('No token or user ID found. Using mock data or requiring login.');
                loadMockData();
                return;
            }
            ws = new WebSocket(`ws://localhost:8081/ws/chat?token=${token}`);

            ws.onopen = () => {
                fetchUserDetails();
                fetchOnlineUsers();
                fetchUserGroups();
                console.log('WebSocket opened for User:', userId);
            };
           ws.onmessage = (event) => {
                console.log('Raw WebSocket data:', event.data);
            try {
                const message = JSON.parse(event.data);
                console.log('Received message:', message, 'for User:', localStorage.getItem('user_id'), 'Active Chat:', activeChat);
                if (message.error) {
                    console.error('WebSocket error:', message.error);
                    return;
                }
                const currentUserId = parseInt(localStorage.getItem('user_id')) || 0;
                if (message.sender_id === currentUserId && message.status === 'sent') {
                    message.status = 'seen';
                    console.log('Updated status to seen for message:', message);
                }
                displayMessage(message);
            } catch (err) {
                console.error('Error parsing WebSocket message:', err, 'Raw data:', event.data);
            }
        };
           

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket closed, reconnecting...');
                setTimeout(connectWebSocket, 3000);
            };
        }
       
       
       
        


function setActiveChat(chatType, chatId, chatName) {
    activeChat = { type: chatType, id: chatId, name: chatName };
    console.log('ActiveChat set to:', activeChat);
    connectWebSocket();
}

// Ensure activeChat is set on page load
document.addEventListener('DOMContentLoaded', () => {
    const initialGroupId = 5; // Known group ID
    const initialGroupName = 'Tech support team';
    setActiveChat('group', initialGroupId, initialGroupName);
});
        // Load Mock Data
        function loadMockData() {
            sidebarName.textContent = localStorage.getItem('sidebarName') || 'John Doe';
            sidebarDesignation.textContent = localStorage.getItem('sidebarDesignation') || 'Software Engineer';
            displayOnlineUsers(mockUsers);
            displayUserGroups(mockGroups);
        }

        // // Fetch User Details
        async function fetchUserDetails() {
            const token = localStorage.getItem('token');
            if (!token) return;
            try {
                const res = await fetch('http://localhost:8080/users/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    sidebarName.textContent = data.name || 'Unknown User';
                    sidebarDesignation.textContent = data.designation || 'N/A';
                    localStorage.setItem('sidebarName', data.name);
                    localStorage.setItem('sidebarDesignation', data.designation || 'N/A');
                    localStorage.setItem('user_id', data.id);
                    console.log('Fetched User Details:', data);
                    logUserDetails();
                } else {
                    console.error('Failed to fetch user details:', res.status);
                    loadMockData();
                }
            } catch (err) {
                console.error('Error fetching user details:', err);
                loadMockData();
            }
        }

        // Fetch Online Users
        async function fetchOnlineUsers() {
            const token = localStorage.getItem('token');
            if (!token) return;
            try {
                const res = await fetch('http://localhost:8080/users/all-users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    console.log('Fetched users:', data.users);
                    data.users.forEach(user => userMap.set(user.id, user.name));
                    displayOnlineUsers(data.users);
                } else {
                    console.error('Failed to fetch online users:', res.status);
                    displayOnlineUsers(mockUsers);
                }
            } catch (err) {
                console.error('Error fetching online users:', err);
                displayOnlineUsers(mockUsers);
            }
        }

        // Fetch User Groups
    async function fetchUserGroups() {
    const token = localStorage.getItem('token');
    console.log('Token:', token);
    if (!token) {
        console.error('No token found in localStorage');
        return;
    }
    try {
        const res = await fetch('http://localhost:8080/users/user-groups', {
            headers: { 'Authorization': `Bearer ${token}` },
            method: 'GET'
        });
        console.log('Response status:', res.status);
        console.log('Response headers:', Object.fromEntries(res.headers.entries()));
        if (res.ok) {
            const data = await res.json();
            console.log('Fetched data:', data);
            const groups = data.groups || []; // Ensure groups is an array
            displayUserGroups(groups);
        } else {
            const errorText = await res.text();
            console.error('Failed to fetch user groups:', res.status, errorText);
            displayUserGroups(mockGroups); // Fallback to mock data
        }
    } catch (err) {
        console.error('Error fetching user groups:', err);
        displayUserGroups(mockGroups); // Fallback to mock data
    }
}
        // Display Online Users
        function displayOnlineUsers(users) {
            onlineUsersList.innerHTML = '';
            const onlineUsers = users.filter(user => user.status === 'online');
            onlineUsers.forEach(user => {
                const li = document.createElement('li');
                li.className = 'flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer';
                li.innerHTML = `
                    <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                    <span>${user.name || 'Unknown'}</span>`;
                li.dataset.userId = user.id;
                li.addEventListener('click', () => {
                    setActiveChat('user', user.id, user.name, user.status);
                });
                onlineUsersList.appendChild(li);
            });
            const offlineUsers = users.filter(user => user.status !== 'online');
            offlineUsers.forEach(user => {
                const li = document.createElement('li');
                li.className = 'flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer';
                li.innerHTML = `
                    <span class="w-3 h-3 bg-gray-500 rounded-full mr-2"></span>
                    <span>${user.name || 'Unknown'}</span>`;
                li.dataset.userId = user.id;
                li.addEventListener('click', () => {
                    setActiveChat('user', user.id, user.name, user.status);
                });
                onlineUsersList.appendChild(li);
            });
        }

  
        function displayUserGroups(groups) {
    userGroupsList.innerHTML = '';
    console.log('Displaying groups:', groups);
    if (!groups || groups.length === 0) {
        console.warn('No groups to display');
        userGroupsList.innerHTML = '<li style="color: red;">No groups available</li>';
        return;
    }
    groups.forEach(group => {
        console.log('Group data:', group);
        const li = document.createElement('li');
        li.className = 'flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer';
        li.innerHTML = `
            <span class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center mr-2">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
            </span>
            <span>${group.Name || 'Unnamed Group'}</span>`;
        li.dataset.groupId = group.ID || group.id; // Use ID from backend
        li.dataset.groupName = group.Name || group.name; // Capture name
        li.dataset.groupMemberCount = group.memberCount || 'Unknown'; // Capture member count
        li.addEventListener('click', () => {
            const id = parseInt(li.dataset.groupId);
            const name = li.dataset.groupName;
            const memberCount = li.dataset.groupMemberCount;
            setActiveChat('group', id, name, memberCount);
            console.log('Clicked group:', { id, name, memberCount }); // Debug
        });
        userGroupsList.appendChild(li);
    });
}

        // // Set Active Chat
        // function setActiveChat(type, id, name, extraInfo) {
        //     activeChat = { type, id, name };
        //     console.log('Active chat set to:', activeChat, 'for User:', localStorage.getItem('user_id'));
        //     chatHeader.textContent = name;
        //     chatSubHeader.textContent = type === 'user' ? (extraInfo === 'online' ? 'Online' : 'Offline') : `${extraInfo} members`;
        //     chatArea.innerHTML = '';
        //     logUserDetails();
        // }
        function setActiveChat(type, id, name, extraInfo) {
    activeChat = { type, id, name };
    console.log('Active chat set to:', { type, id, name, extraInfo }, 'for User:', localStorage.getItem('user_id'));
    chatHeader.textContent = name || 'Unknown Chat';
    chatSubHeader.textContent = type === 'user' ? (extraInfo === 'online' ? 'Online' : 'Offline') : `${extraInfo || 0} members`;
    chatArea.innerHTML = '';
    logUserDetails();
    if (type === 'group' && ws) {
        connectWebSocket(); // Reconnect with group_id
    }
}
        // Display Message with Correct Alignment and Forward
        const displayedMessages = new Map();
        // function displayMessage(message) {
        //     console.log('Attempting to display message:', message, 'Active chat:', activeChat);
        //     if (!activeChat || !activeChat.type) {
        //         console.log('No active chat, skipping display');
        //         return;
        //     }
        //     const currentUserId = parseInt(localStorage.getItem('user_id')) || 0;
        //     console.log('Current User ID:', currentUserId, 'Message Sender ID:', message.sender_id);
        //     const messageKey = message.tempId || `${message.sender_id}-${message.created_at}-${message.content}`;
        //     if (displayedMessages.has(messageKey)) {
        //         console.log('Duplicate message skipped:', message);
        //         return;
        //     }
        //     displayedMessages.set(messageKey, message);

        //     const isForActiveChat = 
        //         (message.targetType === 'user' && activeChat.type === 'user' &&
        //          (message.receiver_id === activeChat.id || 
        //           message.sender_id === activeChat.id || 
        //           message.sender_id === currentUserId));
        //     console.log('isForActiveChat:', isForActiveChat);

        //     if (!isForActiveChat) {
        //         console.log('Message ignored, not for active chat:', message);
        //         return;
        //     }

        //     if (message.type === 'text') {
        //         const senderName = userMap.get(message.sender_id) || `User ${message.sender_id}`;
        //         const isSentByMe = message.sender_id === currentUserId;
        //         console.log('isSentByMe:', isSentByMe, 'Current:', currentUserId, 'Sender:', message.sender_id);
        //         const status = message.status || 'sent';
        //         let tickIcon = '';
        //         if (isSentByMe) {
        //             tickIcon = status === 'seen' ? '‚úì‚úì' : '‚úì';
        //         }

        //         const messageDiv = document.createElement('div');
        //         messageDiv.className = `mb-4 ${isSentByMe ? 'text-right' : 'text-left'}`;
        //         messageDiv.innerHTML = `
        //             <p class="text-gray-600 text-sm">${!isSentByMe ? senderName : ''}</p>
        //             <div class="message-bubble relative ${isSentByMe ? 'bg-indigo-600 text-white' : 'bg-gray-300'}">
        //                 ${message.content || '[Empty Message]'}
        //                 ${isSentByMe ? `<span class="tick">${tickIcon}</span>` : ''}
        //                 ${isSentByMe ? '<span class="forward-btn" onclick="showForwardModal(\'' + message.content + '\')">‚Ü™</span>' : ''}
        //             </div>
        //             <p class="text-gray-500 text-xs mt-1">${new Date(message.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
        //         `;
        //         console.log('Appending message to chatArea, isSentByMe:', isSentByMe, 'Status:', status);
        //         chatArea.appendChild(messageDiv);
        //         chatArea.scrollTop = chatArea.scrollHeight;
        //     }
        // }

        // Send Message with Status Tracking
      
        function displayMessage(message) {
    console.log('Attempting to display message:', message, 'Active chat:', activeChat);
    if (!activeChat || !activeChat.type || !activeChat.id) {
        console.log('No active chat, skipping display. ActiveChat:', activeChat);
        return;
    }
    const currentUserId = parseInt(localStorage.getItem('user_id')) || 0;
    console.log('Current User ID:', currentUserId, 'Message Sender ID:', message.sender_id);

    const messageKey = message.tempId || `${message.sender_id}-${message.created_at}-${message.content}`;
    if (displayedMessages.has(messageKey)) {
        console.log('Duplicate message skipped:', message);
        return;
    }
    displayedMessages.set(messageKey, message);

    const isForActiveChat = 
        (message.targetType === 'user' && activeChat.type === 'user' && 
         (message.receiver_id === activeChat.id || message.sender_id === activeChat.id || message.sender_id === currentUserId)) ||
        (message.targetType === 'group' && activeChat.type === 'group' && message.group_id === activeChat.id);
    console.log('isForActiveChat check:', {
        messageTargetType: message.targetType,
        activeChatType: activeChat.type,
        messageGroupId: message.group_id,
        activeChatId: activeChat.id,
        condition: isForActiveChat
    });

    if (!isForActiveChat) {
        console.log('Message ignored, not for active chat. Possible reasons:', {
            targetTypeMatch: message.targetType === 'group' && activeChat.type === 'group',
            groupIdMatch: message.group_id === activeChat.id
        });
        return;
    }

    if (message.type === 'text') {
        const senderName = userMap.get(message.sender_id) || `User ${message.sender_id}`;
        const isSentByMe = message.sender_id === currentUserId;
        console.log('isSentByMe:', isSentByMe, 'Current:', currentUserId, 'Sender:', message.sender_id);
        const status = message.status || 'sent';
        let tickIcon = '';
        if (isSentByMe) {
            tickIcon = status === 'seen' ? '‚úì‚úì' : '‚úì';
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-4 ${isSentByMe ? 'text-right' : 'text-left'}`;
        messageDiv.innerHTML = `
            <p class="text-gray-600 text-sm">${activeChat.type === 'group' ? senderName : (isSentByMe ? '' : senderName)}</p>
            <div class="message-bubble relative ${isSentByMe ? 'bg-indigo-600 text-white' : 'bg-gray-300'}">
                ${message.content || '[Empty Message]'}
                ${isSentByMe ? `<span class="tick">${tickIcon}</span>` : ''}
                ${isSentByMe ? '<span class="forward-btn" onclick="showForwardModal(\'' + message.content + '\')">‚Ü™</span>' : ''}
            </div>
            <p class="text-gray-500 text-xs mt-1">${new Date(message.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
        `;
        console.log('Appending message to chatArea, isSentByMe:', isSentByMe, 'Status:', status);
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
}
      
        sendBtn.addEventListener('click', () => {
            console.log('Send button clicked');
            const content = messageInput.value.trim();
            console.log('Raw input:', messageInput.value, 'Trimmed content:', content);
            console.log('ActiveChat:', activeChat);
            if (!content) {
                console.log('Empty message entered');
                alert('Please type a message before sending.');
                return;
            }
            if (!activeChat || !activeChat.type || !activeChat.id) {
                console.log('No active chat selected');
                alert('Please select a user or group from the sidebar.');
                return;
            }
            const currentUserId = parseInt(localStorage.getItem('user_id'));
            if (isNaN(currentUserId)) {
                console.error('Invalid user_id:', currentUserId, 'Setting to default for debugging');
                localStorage.setItem('user_id', prompt('Enter your user ID (e.g., 3 for Alan, 5 for Sujith):') || 0);
                return;
            }
            const tempMessageId = Date.now();
            const messageData = {
                type: activeChat.type === 'user' ? 'personal_message' : 'group_message',
                targetId: activeChat.type === 'user' ? activeChat.id : undefined,
                group_id: activeChat.type === 'group' ? activeChat.id : undefined,
                content: content,
                tempId: tempMessageId,
                status: 'sent',
                sender_id: currentUserId,
                receiver_id: activeChat.type === 'user' ? activeChat.id : undefined
            };
            const localMessage = {
                sender_id: currentUserId,
                type: 'text',
                targetType: activeChat.type,
                [activeChat.type === 'user' ? 'receiver_id' : 'group_id']: activeChat.id,
                content: content,
                created_at: new Date().toISOString(),
                tempId: tempMessageId,
                status: 'sent'
            };

            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log('Sending message:', messageData);
                ws.send(JSON.stringify(messageData));
                console.log('Displaying locally:', localMessage);
                displayMessage(localMessage);
            } else {
                console.log('WebSocket not open, displaying locally');
                console.log('Displaying locally:', localMessage);
                displayMessage(localMessage);
            }
            messageInput.value = '';
        });

        // Enter Key to Send
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });

        // Mic Button for Recording
        let recordingTimer;
        micBtn.addEventListener('click', () => {
            isRecording = !isRecording;
            if (isRecording) {
                recordingIndicator.classList.remove('hidden');
                recordingIndicator.classList.add('recording-animation');
                console.log('Recording started');
                recordingTimer = setTimeout(() => {
                    isRecording = false;
                    recordingIndicator.classList.add('hidden');
                    recordingIndicator.classList.remove('recording-animation');
                    console.log('Recording stopped after 5 seconds');
                    alert('Recording stopped. (Simulated)');
                }, 5000);
            } else {
                clearTimeout(recordingTimer);
                recordingIndicator.classList.add('hidden');
                recordingIndicator.classList.remove('recording-animation');
                console.log('Recording stopped manually');
            }
        });

        // Attachment Modal
        attachmentBtn.addEventListener('click', () => {
            attachmentModal.style.display = 'block';
        });

        // Notification Modal
        notificationBtn.addEventListener('click', () => {
            notificationModal.style.display = 'block';
            const badge = document.getElementById('notificationBadge');
            badge.textContent = mockNotifications.length;
            badge.classList.remove('hidden');
        });

        function displayNotifications(notifications) {
            notificationList.innerHTML = '';
            notifications.forEach(notif => {
                const li = document.createElement('li');
                li.className = 'p-2 hover:bg-gray-100';
                li.innerHTML = `
                    <span>${notif.message}</span>
                    <span class="text-xs text-gray-500 ml-2">${notif.time}</span>
                `;
                notificationList.appendChild(li);
            });
        }

        // Emoji Modal
        function populateEmojis() {
            emojis.forEach(emoji => {
                const span = document.createElement('span');
                span.className = 'text-2xl cursor-pointer hover:bg-gray-200 p-2 rounded';
                span.textContent = emoji;
                span.addEventListener('click', () => {
                    messageInput.value += emoji;
                    emojiModal.style.display = 'none';
                    messageInput.focus();
                });
                emojiList.appendChild(span);
            });
        }
        emojiBtn.addEventListener('click', () => {
            emojiModal.style.display = 'block';
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('profilePhoto');
            localStorage.removeItem('user_id');
            alert('Logged out successfully!');
            window.location.href = '/auth/login';
            loadMockData();
        });

        // Chat Status Button
        let isOnline = true;
        chatStatusBtn.addEventListener('click', () => {
            isOnline = !isOnline;
            chatStatusBtn.textContent = isOnline ? 'Go Offline' : 'Go Online';
            chatStatusBtn.classList.toggle('bg-green-500', isOnline);
            chatStatusBtn.classList.toggle('bg-red-500', !isOnline);
            console.log('Chat status toggled to:', isOnline ? 'online' : 'offline');
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'status_update', status: isOnline ? 'online' : 'offline' }));
            }
        });

        // Search Functionality
        function setupSearch() {
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                fetchOnlineUsers().then(() => {
                    const users = [...mockUsers];
                    const filteredUsers = users.filter(user => user.name.toLowerCase().includes(query));
                    displayOnlineUsers(filteredUsers);
                });
                fetchUserGroups().then(() => {
                    const groups = [...mockGroups];
                    const filteredGroups = groups.filter(group => group.name.toLowerCase().includes(query));
                    displayUserGroups(filteredGroups);
                });
            });
        }

        // Forward Modal
        window.showForwardModal = function(content) {
            forwardList.innerHTML = '';
            [...mockUsers, ...mockGroups.map(g => ({ id: g.id, name: g.name, status: 'group' }))].forEach(target => {
                const li = document.createElement('li');
                li.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                li.innerHTML = `
                    <span>${target.name} ${target.status === 'group' ? '(Group)' : (target.status === 'online' ? '(Online)' : '(Offline)')}</span>
                `;
                li.addEventListener('click', () => {
                    console.log(`Forwarding "${content}" to ${target.name}`);
                    alert(`Forwarded to ${target.name}. (Simulated)`);
                    forwardModal.style.display = 'none';
                });
                forwardList.appendChild(li);
            });
            forwardModal.style.display = 'block';
        };

        // Close Modals
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', () => {
                attachmentModal.style.display = 'none';
                notificationModal.style.display = 'none';
                emojiModal.style.display = 'none';
                forwardModal.style.display = 'none';
            });
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === attachmentModal) attachmentModal.style.display = 'none';
            if (e.target === notificationModal) notificationModal.style.display = 'none';
            if (e.target === emojiModal) emojiModal.style.display = 'none';
            if (e.target === forwardModal) forwardModal.style.display = 'none';
        });
    </script>
</body>
</html>