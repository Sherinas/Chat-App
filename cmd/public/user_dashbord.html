<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectSphere - Chat Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom background lines */
        .background-lines {
            position: absolute;
            inset: 0;
            overflow: hidden;
            z-index: 0;
        }
        .line {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            transform-origin: center;
        }
        .line-1 { width: 200%; height: 1px; top: 20%; left: -50%; transform: rotate(45deg); animation: moveLine1 10s linear infinite; }
        .line-2 { width: 200%; height: 1px; bottom: 20%; left: -50%; transform: rotate(-45deg); animation: moveLine2 12s linear infinite; }
        .line-3 { width: 1px; height: 200%; left: 30%; top: -50%; transform: rotate(30deg); animation: moveLine3 8s linear infinite; }

        @keyframes moveLine1 { 0% { transform: rotate(45deg) translateX(-100%); } 100% { transform: rotate(45deg) translateX(100%); } }
        @keyframes moveLine2 { 0% { transform: rotate(-45deg) translateX(100%); } 100% { transform: rotate(-45deg) translateX(-100%); } }
        @keyframes moveLine3 { 0% { transform: rotate(30deg) translateY(-100%); } 100% { transform: rotate(30deg) translateY(100%); } }

        .logo-animation { animation: rotateFlip 4s ease-in-out infinite; }
        @keyframes rotateFlip {
            0% { transform: rotate(0deg) scaleX(1); } 25% { transform: rotate(90deg) scaleX(1); }
            50% { transform: rotate(180deg) scaleX(-1); } 75% { transform: rotate(270deg) scaleX(-1); }
            100% { transform: rotate(360deg) scaleX(1); }
        }

        .chat-area::-webkit-scrollbar { width: 6px; }
        .chat-area::-webkit-scrollbar-track { background: transparent; }
        .chat-area::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 3px; }
        .chat-area::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        .sidebar { transition: transform 0.3s ease-in-out; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); position: fixed; z-index: 50; }
            .sidebar.open { transform: translateX(0); }
            .chat-area { margin-left: 0 !important; }
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            border-radius: 9999px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen flex bg-gray-100">
    <!-- Background Lines -->
    <div class="background-lines">
        <div class="line line-1"></div>
        <div class="line line-2"></div>
        <div class="line line-3"></div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar w-64 p-4 flex flex-col h-screen bg-gray-800 text-white shadow-lg z-10">
        <div class="flex items-center mb-6">
            <a href="/users/profile" class="flex items-center">
                <div class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center mr-3 logo-animation">
                    <img id="sidebarProfilePhoto" src="https://via.placeholder.com/48" alt="Profile Photo" class="w-full h-full rounded-full object-cover">
                </div>
                <div>
                    <h2 id="sidebarName" class="text-lg font-semibold">John Doe</h2>
                    <p id="sidebarDesignation" class="text-sm text-gray-400">Software Engineer</p>
                </div>
            </a>
        </div>
        <button id="logout-button" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 mb-6">
            Logout
        </button>
        <div class="mb-6">
            <h3 class="text-sm font-semibold text-gray-400 mb-2">ONLINE USERS</h3>
            <ul id="onlineUsersList" class="space-y-2"></ul>
        </div>
        <div>
            <h3 class="text-sm font-semibold text-gray-400 mb-2">GROUPS</h3>
            <ul id="userGroupsList" class="space-y-2"></ul>
        </div>
    </div>

    <!-- Chat Area -->
    <div id="chatAreaContainer" class="flex-1 flex flex-col h-screen bg-gray-100 text-gray-900 relative z-0">
        <div class="bg-gray-200 p-4 flex items-center justify-between shadow-md">
            <div class="flex items-center">
                <button id="menuBtn" class="md:hidden p-2 text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                <h2 id="chatHeader" class="text-lg font-semibold">Select a chat</h2>
                <span id="chatSubHeader" class="ml-2 text-sm text-gray-500"></span>
            </div>
            <div class="relative">
                <button class="p-2 text-gray-600 hover:text-indigo-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span id="notificationBadge" class="notification-badge hidden">0</span>
                </button>
            </div>
        </div>

        <div id="chatArea" class="flex-1 p-4 overflow-y-auto chat-area"></div>

        <div class="bg-gray-200 p-4 flex items-center shadow-md">
            <button id="voiceChatBtn" class="p-2 text-gray-600 hover:text-indigo-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3zM6 10a6 6 0 0012 0M6 10V8m12 2V8m-3 10a3 3 0 01-6 0H6a6 6 0 0012 0h-3z"></path>
                </svg>
            </button>
            <button id="emojiBtn" class="p-2 text-gray-600 hover:text-indigo-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </button>
            <button id="mediaBtn" class="p-2 text-gray-600 hover:text-indigo-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.586-6.586a4 4 0 00-5.656-5.656L5.757 10.757a6 6 0 108.486 8.486L21 12"></path>
                </svg>
            </button>
            <input 
                type="text" 
                id="messageInput" 
                class="flex-1 px-4 py-2 bg-gray-300 border border-gray-400 rounded-lg text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                placeholder="Type your message..."
            >
            <button id="sendBtn" class="p-2 bg-indigo-600 hover:bg-indigo-700 rounded-full ml-2">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Mock data for development
        const mockUsers = [
            { id: 1, name: "Alice Smith", status: "online" },
            { id: 2, name: "Bob Johnson", status: "online" },
            { id: 3, name: "Carol Williams", status: "offline" }
        ];
        const mockGroups = [
            { id: 1, name: "Engineering Team", memberCount: 5 },
            { id: 2, name: "Marketing Team", memberCount: 3 }
        ];

        // DOM Elements
        const menuBtn = document.getElementById('menuBtn');
        const sidebar = document.getElementById('sidebar');
        const chatArea = document.getElementById('chatArea');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const emojiBtn = document.getElementById('emojiBtn');
        const mediaBtn = document.getElementById('mediaBtn');
        const voiceChatBtn = document.getElementById('voiceChatBtn');
        const sidebarName = document.getElementById('sidebarName');
        const sidebarDesignation = document.getElementById('sidebarDesignation');
        const onlineUsersList = document.getElementById('onlineUsersList');
        const userGroupsList = document.getElementById('userGroupsList');
        const logoutButton = document.getElementById('logout-button');
        const sidebarProfilePhoto = document.getElementById('sidebarProfilePhoto');
        const chatHeader = document.getElementById('chatHeader');
        const chatSubHeader = document.getElementById('chatSubHeader');

        // Global Variables
        let ws;
        let activeChat = null;
        const userMap = new Map();

        // Initialize on Page Load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, clearing chat area');
            chatArea.innerHTML = ''; // Ensure chat area is empty on load
            const savedPhoto = localStorage.getItem('profilePhoto');
            if (savedPhoto) {
                sidebarProfilePhoto.src = savedPhoto;
                sidebarProfilePhoto.onerror = () => { sidebarProfilePhoto.src = 'https://via.placeholder.com/48'; };
            }
            connectWebSocket();
        });

        // Sidebar Toggle for Mobile
        menuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        // WebSocket Connection
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log('WebSocket already connected');
                return;
            }
            const token = localStorage.getItem('token');
            if (!token) {
                console.log("No token found. Using mock data.");
                loadMockData();
                return;
            }
            console.log('Connecting with token:', token);
            ws = new WebSocket(`ws://localhost:8081/ws/chat?token=${token}`);

            ws.onopen = () => {
                console.log('Connected to WebSocket server');
                fetchUserDetails();
                fetchOnlineUsers();
                fetchUserGroups();
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    console.log('Received:', message);
                    if (message.error) {
                        console.error('WebSocket error:', message.error);
                        return;
                    }
                    displayMessage(message);
                } catch (err) {
                    console.error('Error parsing WebSocket message:', err);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket closed, reconnecting...');
                setTimeout(connectWebSocket, 3000);
            };
        }

        // Load Mock Data
        function loadMockData() {
            sidebarName.textContent = localStorage.getItem('sidebarName') || 'John Doe';
            sidebarDesignation.textContent = localStorage.getItem('sidebarDesignation') || 'Software Engineer';
            displayOnlineUsers(mockUsers);
            displayUserGroups(mockGroups);
        }

        // Fetch User Details
        async function fetchUserDetails() {
            const token = localStorage.getItem('token');
            if (!token) return;
            try {
                const res = await fetch('http://localhost:8080/users/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    sidebarName.textContent = data.name || 'Unknown User';
                    sidebarDesignation.textContent = data.designation || 'N/A';
                    localStorage.setItem('sidebarName', data.name);
                    localStorage.setItem('sidebarDesignation', data.designation || 'N/A');
                    localStorage.setItem('user_id', data.id); // Store user ID
                } else {
                    console.error('Failed to fetch user details:', res.status);
                    loadMockData();
                }
            } catch (err) {
                console.error('Error fetching user details:', err);
                loadMockData();
            }
        }

        // Fetch Online Users
        async function fetchOnlineUsers() {
            const token = localStorage.getItem('token');
            if (!token) return;
            try {
                const res = await fetch('http://localhost:8080/users/all-users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    console.log('Fetched users:', data.users);
                    data.users.forEach(user => userMap.set(user.id, user.name)); // Populate userMap
                    displayOnlineUsers(data.users);
                } else {
                    console.error('Failed to fetch online users:', res.status);
                    displayOnlineUsers(mockUsers);
                }
            } catch (err) {
                console.error('Error fetching online users:', err);
                displayOnlineUsers(mockUsers);
            }
        }

        // Fetch User Groups
        async function fetchUserGroups() {
            const token = localStorage.getItem('token');
            if (!token) return;
            try {
                const res = await fetch('http://localhost:8080/groups/user-groups', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const groups = await res.json();
                    console.log('Fetched groups:', groups);
                    displayUserGroups(groups);
                } else {
                    console.error('Failed to fetch user groups:', res.status);
                    displayUserGroups(mockGroups);
                }
            } catch (err) {
                console.error('Error fetching user groups:', err);
                displayUserGroups(mockGroups);
            }
        }

        // Display Online Users
        function displayOnlineUsers(users) {
            onlineUsersList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.className = 'flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer';
                li.innerHTML = `
                    <span class="w-3 h-3 bg-${user.status === 'online' ? 'green' : 'gray'}-500 rounded-full mr-2"></span>
                    <span>${user.name || 'Unknown'}</span>`;
                li.dataset.userId = user.id;
                li.addEventListener('click', () => {
                    setActiveChat('user', user.id, user.name, user.status);
                });
                onlineUsersList.appendChild(li);
            });
        }

        // Display User Groups
        function displayUserGroups(groups) {
            userGroupsList.innerHTML = '';
            groups.forEach(group => {
                const li = document.createElement('li');
                li.className = 'flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer';
                li.innerHTML = `
                    <span class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center mr-2">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                    </span>
                    <span>${group.name || 'Unnamed Group'}</span>`;
                li.dataset.groupId = group.id;
                li.addEventListener('click', () => {
                    setActiveChat('group', group.id, group.name, group.memberCount || 'Unknown');
                });
                userGroupsList.appendChild(li);
            });
        }

        // Set Active Chat
        function setActiveChat(type, id, name, extraInfo) {
            activeChat = { type, id, name };
            console.log('Active chat set:', activeChat);
            chatHeader.textContent = name;
            chatSubHeader.textContent = type === 'user' ? (extraInfo === 'online' ? 'Online' : 'Offline') : `${extraInfo} members`;
            chatArea.innerHTML = ''; // Clear chat area when switching
            // Future: Load chat history here if needed
        }

        // Display Message
        function displayMessage(message) {
            console.log('Attempting to display:', message, 'Active chat:', activeChat);
            if (!activeChat || !activeChat.type) {
                console.log('No active chat, skipping display');
                return;
            }

            const isForActiveChat =
                (message.targetType === 'user' && activeChat.type === 'user' &&
                 (message.receiver_id === activeChat.id || message.sender_id === activeChat.id)) ||
                (message.targetType === 'group' && activeChat.type === 'group' &&
                 message.group_id === activeChat.id);

            if (!isForActiveChat) {
                console.log('Message ignored, not for active chat:', message);
                return;
            }

            if (message.type === 'text') {
                const senderName = userMap.get(message.sender_id) || `User ${message.sender_id}`;
                const isSentByMe = message.sender_id === parseInt(localStorage.getItem('user_id'));
                const messageDiv = document.createElement('div');
                messageDiv.className = `mb-4 ${isSentByMe ? 'text-right' : ''}`;
                messageDiv.innerHTML = `
                    <p class="text-gray-600 text-sm">${senderName}</p>
                    <div class="${isSentByMe ? 'bg-indigo-600 text-white' : 'bg-gray-300'} p-3 rounded-lg inline-block shadow-sm">
                        ${message.content || '[Empty Message]'}
                    </div>
                    <p class="text-gray-500 text-xs mt-1">${new Date(message.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                `;
                console.log('Appending message to chatArea');
                chatArea.appendChild(messageDiv);
                chatArea.scrollTop = chatArea.scrollHeight;
            } else {
                console.error('Unsupported message type:', message.type);
            }
        }

        // Send Message
        sendBtn.addEventListener('click', () => {
            console.log('Send button clicked');
            const content = messageInput.value.trim();
            console.log('Raw input:', messageInput.value, 'Trimmed content:', content);
            if (!content) {
                console.log('Empty message entered');
                alert('Please type a message before sending.');
                return;
            }
            if (!activeChat || !activeChat.type || !activeChat.id) {
                console.log('No active chat selected');
                alert('Please select a user or group from the sidebar before sending a message.');
                return;
            }
            const messageData = {
                type: activeChat.type === 'user' ? 'personal_message' : 'group_message',
                targetId: activeChat.type === 'user' ? activeChat.id : undefined,
                group_id: activeChat.type === 'group' ? activeChat.id : undefined,
                content: content
            };
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log('Sending message:', messageData);
                ws.send(JSON.stringify(messageData));
            } else {
                console.log('WebSocket not open, displaying locally');
                displayMessage({
                    sender_id: parseInt(localStorage.getItem('user_id')),
                    type: 'text',
                    targetType: activeChat.type,
                    [activeChat.type === 'user' ? 'receiver_id' : 'group_id']: activeChat.id,
                    content: content,
                    created_at: new Date().toISOString()
                });
            }
            messageInput.value = '';
        });

        // Enter Key to Send
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });

        // Emoji Button
        emojiBtn.addEventListener('click', () => {
            messageInput.value += '😊';
            messageInput.focus();
        });

        // Media Button
        mediaBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const messageData = {
                            type: file.type.startsWith('image') ? 'image' : 'video',
                            content: event.target.result,
                            targetType: activeChat.type,
                            [activeChat.type === 'user' ? 'targetId' : 'group_id']: activeChat.id
                        };
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(JSON.stringify(messageData));
                        } else {
                            displayMessage({
                                sender_id: parseInt(localStorage.getItem('user_id')),
                                ...messageData,
                                created_at: new Date().toISOString()
                            });
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        });

        // Voice Chat Button
        voiceChatBtn.addEventListener('click', () => {
            alert('Voice chat feature coming soon!');
        });

        // Logout
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('profilePhoto');
            localStorage.removeItem('user_id');
            alert('Logged out successfully!');
            window.location.href = '/login'; // Redirect to login in production
            loadMockData(); // For development
        });
    </script>
</body>
</html>